Return-Path: <live-patching+bounces-1515-lists+live-patching=lfdr.de@vger.kernel.org>
X-Original-To: lists+live-patching@lfdr.de
Delivered-To: lists+live-patching@lfdr.de
Received: from sy.mirrors.kernel.org (sy.mirrors.kernel.org [147.75.48.161])
	by mail.lfdr.de (Postfix) with ESMTPS id 9227BAD5ED0
	for <lists+live-patching@lfdr.de>; Wed, 11 Jun 2025 21:09:02 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sy.mirrors.kernel.org (Postfix) with ESMTPS id 41F157A94BB
	for <lists+live-patching@lfdr.de>; Wed, 11 Jun 2025 19:07:41 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 8BD59288CB9;
	Wed, 11 Jun 2025 19:08:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="PV6rCjMO"
X-Original-To: live-patching@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 6458025F7A8;
	Wed, 11 Jun 2025 19:08:55 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1749668935; cv=none; b=pFcxg7zBS1HtaedT1NHCAys6Z0sRLgAqmTuO+JvMNwIp1sPfJ9t7HZOiM97AU/hPSoU9jL3sXFbV1nNKiF//X38sYzo0gKTqcysUpf+CMqAcIjX9f4Yamulq3nkJY1GfqvbzNTK1Wy5KvdDVHEqzqnKXfB7aRtqTCOJMR7wq0ZE=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1749668935; c=relaxed/simple;
	bh=D/uwyo7UifZpTRyojzbRLzU2O6UeHlW48QEw4MTf1ik=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=vDmFxiQQ2N5T9VRP8VG/+LKjqGZrbuBkar7YWHGvdeE28J7xjiEoPTmc6+IxQpcItXRnWZVmKjztIKfYcbp5WCHeB+HiKq1TocgT2v8oGZYsqotcxX/r+aCRminDJtXXCDaBNBu6++NbPvefkl3WrR+Rm5PdR6GHHLam6uF8O+0=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=PV6rCjMO; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id C49A4C4CEE3;
	Wed, 11 Jun 2025 19:08:53 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1749668934;
	bh=D/uwyo7UifZpTRyojzbRLzU2O6UeHlW48QEw4MTf1ik=;
	h=Date:From:To:Cc:Subject:References:In-Reply-To:From;
	b=PV6rCjMOzrXjUf2EN0/RO/DOXU50jNZPNx/M8d4UXMC+jEE705t1RcN0d9SrNsCGV
	 VUxyrR3/G3e0SqAApero/YD53vt7N26BPiF9KdPD9EtWopuLHVJMMatO3vBFclJaWG
	 wF8AuUa8sxXDCx30EnYbifC/5oRoJ+F/wSh7aGx/WbCl9bmv6XsMshwZV0aQEmaGyR
	 6/XFfssoC2C8IF4FS9NEj5ewEeM0WG5jIfzxwe1IpxlvnpG+HYMM9EO5QYLA3tioK/
	 sY7kdt7U1em2HYqzC6afbmmua/ImgNKhPwrPhY3kkOh20ptyDsEwAs6FupMcbVIbTC
	 RShPUz9ilobPA==
Date: Wed, 11 Jun 2025 12:08:52 -0700
From: Josh Poimboeuf <jpoimboe@kernel.org>
To: Joe Lawrence <joe.lawrence@redhat.com>
Cc: x86@kernel.org, linux-kernel@vger.kernel.org, 
	Petr Mladek <pmladek@suse.com>, Miroslav Benes <mbenes@suse.cz>, live-patching@vger.kernel.org, 
	Song Liu <song@kernel.org>, laokz <laokz@foxmail.com>, Jiri Kosina <jikos@kernel.org>, 
	Marcos Paulo de Souza <mpdesouza@suse.com>, Weinan Liu <wnliu@google.com>, 
	Fazla Mehrab <a.mehrab@bytedance.com>, Chen Zhongjin <chenzhongjin@huawei.com>, 
	Puranjay Mohan <puranjay@kernel.org>
Subject: Re: [PATCH v2 59/62] livepatch/klp-build: Introduce klp-build script
 for generating livepatch modules
Message-ID: <c7bifa7n7ybhqxxwbcl7o5743gl6ezd2odx63qc3nmqwcqpxiy@64oztd4qm3um>
References: <cover.1746821544.git.jpoimboe@kernel.org>
 <10ccbeb0f4bcd7d0a10cc9b9bd12fdc4894f83ee.1746821544.git.jpoimboe@kernel.org>
 <8c79b86e-fc30-4f48-bdd2-91ef6f612bb5@redhat.com>
Precedence: bulk
X-Mailing-List: live-patching@vger.kernel.org
List-Id: <live-patching.vger.kernel.org>
List-Subscribe: <mailto:live-patching+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:live-patching+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
In-Reply-To: <8c79b86e-fc30-4f48-bdd2-91ef6f612bb5@redhat.com>

On Wed, Jun 11, 2025 at 02:44:35PM -0400, Joe Lawrence wrote:
> > +get_patch_files() {
> > +	local patch="$1"
> > +
> > +	grep0 -E '^(--- |\+\+\+ )' "$patch"			\
> > +		| gawk '{print $2}'				\
> 
> If we split the rest of this line on the tab character and print the
> first part of $2:
> 
>   gawk '{ split($2, a, "\t"); print a[1] }'
> 
> then it can additionally handle patches generated by `diff -Nupr` with a
> timepstamp ("--- <filepath>\t<timestamp>").

Hm?  The default gawk behavior is to treat both tabs and groups of
spaces as field separators:

  https://www.gnu.org/software/gawk/manual/html_node/Default-Field-Splitting.html

And it works for me:

  $ diff -Nupr /tmp/meminfo.c fs/proc/meminfo.c > /tmp/a.patch
  $ grep -E '^(--- |\+\+\+ )' /tmp/a.patch | gawk '{print $2}'
  /tmp/meminfo.c
  fs/proc/meminfo.c

Or did I miss something?

> > +# Refresh the patch hunk headers, specifically the line numbers and counts.
> > +refresh_patch() {
> > +	local patch="$1"
> > +	local tmpdir="$PATCH_TMP_DIR"
> > +	local files=()
> > +
> > +	rm -rf "$tmpdir"
> > +	mkdir -p "$tmpdir/a"
> > +	mkdir -p "$tmpdir/b"
> > +
> > +	# Find all source files affected by the patch
> > +	grep0 -E '^(--- |\+\+\+ )[^ /]+' "$patch"	|
> > +		sed -E 's/(--- |\+\+\+ )[^ /]+\///'	|
> > +		sort | uniq | mapfile -t files
> > +
> 
> Should just call `get_patch_files() here?

Indeed.

-- 
Josh

